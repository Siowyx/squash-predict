---
title: "S&DS 425 Report - Squash Match Prediction"
author: "Yee Xian Siow"
date: "17 Dec 2023"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo   =FALSE,      ## show or suppress the code
                      include=TRUE ,      ## show or suppress the output
                      message=FALSE,      ## omit messages generated by code
                      warning=FALSE,      ## omit warnings generated by code
                      comment=NA,         ## removes the ## from in front of outputs
                      fig.align="center", ## centers all figures
                      fig.height = 5,     ## set the default height
                      fig.weight = 5,     ## set the default width
                      fig.width = 8      ## set the default width
                      )
```

## Abstract

In this project, the objective is to forecast the outcomes of squash matches between two players by leveraging historical match results obtained from the Professional Squash Association website up to 26 Nov 2023. The dataset includes information on previous seasons' match results, serving as the basis for training logistic regression models. The predictors for these models are derived from the current game scores, aiming to predict both game and match win probabilities. The predictions generated by the models closely align with the current PSA world rankings, showcasing the efficacy of logistic regression in capturing patterns and dynamics within squash match outcomes. To facilitate user interaction, a shiny app was developed, enabling users to easily predict match outcomes for various players. 


## Introduction 

With the recent inclusion in the 2028 Olympic Games, Squash has garnered increasing attention, and predicting match outcomes is crucial for players, fans, and organizers alike. The motivation behind this project is to attempt to understand the squash match dynamics and develop predictive models for game and match outcomes. The challenge addressed is the inherent uncertainty in forecasting squash matches, considering the multifaceted nature of player skills and strategies.

The dataset used in this project is sourced from the Professional Squash Association website, encompassing match results from previous seasons up to 26 Nov 2023. This comprehensive dataset includes player names, seasons, game scores, and match outcomes, forming the basis for training logistic regression models. The predictive variables are derived from the ongoing game scores, providing a dynamic and real-time approach to forecasting.

The next section contains data extraction and cleaning, which describe the process of getting data from the Professional Squash Association website using the Selenium package. Then, the data exploration section reveals that some players only appeared in a few matches per season. In the data modeling section, we build several different logistic regression models for game and match win probabilities and found that the model predicting game win probabilities has the lowest AIC. The shiny section simply describe how the shiny app works. Then, we discuss the results of the model, including the top 20 coefficients for the players and the corresponding standard errors, in the results section. Finally, we discuss conclusions, limitations, and ideas for future work in the conclusions section.


## Data Extraction and Cleaning

We extracted matches results from the Professional Squash Association website. First, we get the links to all completed tournaments results page from all seasons from the tournaments page (https://www.psaworldtour.com/tournaments/). The challenge for this step is that the html table that display the tournaments from the past seasons are generated dynamically, meaning the html code pulled from the scan() function will only have the links to tournaments in the current season. To solve this problem, we used the Selenium package, which allows us to interact with elements on the webpage. This way, we can select the specific season and extract the links for the corresponding tournaments. 

Once we have the list of all links, we extracted the relevant tournament information and matches results from each link. To do this, we created a function to navigate the html table that contains all information. There were a lot of inconsistencies which results in a html table that has a different format from most that need to be checked. For example, some tournaments were only for one gender, tournaments have different number of players, some results were not recorded, some tournaments used a round robin format, some matches were best of 3 format, etc. The resulting data frame contains information on players names, gender, players tournament seeding, players countries, round (e.g. Final), match results (both games won and points won), tournament names, date of match, tournament location, tournament prize money tier, and season. Each row in the data frame represent a match. There were a total of 73498 matches results across more than 30 seasons extracted.

Next, we did some data cleaning which includes date formatting, ensuring naming consistency for the players, and investigating NA entries. We simply remove the rows with NA scores because this just meant that the match results were not recorded on the website. For some of the NA entries in the player seed and country columns, we were able to cross check with other rows and fill in the correct values from another row with matching players and tournaments. 

Additionally, there were some extra data processing steps before fitting the logistic regression models. The data were filtered based on seasons. Then, a player coefficient matrix is created, where each column represent a player and the entries were set to 1 if the player is player1, -1 if the player is player2, else 0. 

For the first model, which predicts match win probability, the data frame used includes the player coefficient matrix and a column indicating if player1 wins the match. 

For the second model, which predicts match win probability based on current game score, the data frame used includes the current number of games won by each player in addition to the player coefficient matrix and the player1 win indicator. We went through each game in a match in order, determine which player wins the game, and add a row representing the current number of games won by each player. There are as many rows as the number of games. For example, if player1 wins the first game and loses the next three games, the first row will be 1-0, second row will be 1-1, then 1-2 and 1-3. 

For the third model, which predicts game win probability, the data frame used includes the player coefficient matrix and a column indicating if player1 wins the game. Similar to the second model, there are as many rows as the number of games in the data frame. To achieve this, we created columns indicating if player1 won each game and then apply pivot_longer() on the newly created columns. 
 

## Data exploration  

Before fitting the models, we checked the number of matches each player appeared in each season.

```{r}
library(dplyr)
library(ggplot2)
library(pubtheme)

df <- read.csv("data/cleaned_squash.csv")
df <- subset(df, select = -X)
seasons <- ("2023-2024")
df2 <- df %>%
    filter(season %in% seasons)
  
all_players <- unique(c(df2$player1, df2$player2))
n_matches_per_player <- rep(0, length(all_players))
for (i in 1:length(all_players)) {
  n_matches_per_player[i] <- nrow(df2[df2$player1 == all_players[i],]) + nrow(df2[df2$player2 == all_players[i],])
}

d <- data.frame(all_players, n_matches_per_player)
dg <- d %>%
  group_by(n_matches_per_player) %>%
  summarise(player_count = n())

g = ggplot(dg, aes(x=n_matches_per_player, y=player_count))+
  geom_col(width = 0.8)+ 
  labs(title    = "Player Count per Number of Matches Played in 2023-24 Season",
       x = 'Number of Matches Played in 2023-24 Season', 
       y = 'Player Count')
g %>%
  pub(type='bar')

```

The bar plot shows us that in 2023-24 season, there are a large number of players that only appear in a few matches. These players are most likely amateur players or players who are just started playing professionally. To safeguard the model from potential biases or predictions with high standard errors, we decided to code the players that only appeared in not more than 5 matches as "Others". We think that setting the threshold at 5 will be enough to eliminate potential biases. These "Others" players will be the reference players in the model. 


## Modeling/Analysis
Describe regression or classification model(s) used, or the analysis that was performed. For each regression or classification model, discuss 

- any assumptions that are made
- the observation, the predictors, and the outcome (aka the rows of $X$, the columns of $X$, and $y$)
- what model you are using, and write out the model
- what the coefficients mean (when applicable) and how this is related to your problem 
- appropriate measures of the performance of the model, such as measures of fit and predictive ability
- whether or not you think the model is appropriate for this kind of data, and why, and
- how easy/hard it is to interpret the results and explain them to either a technical or non-technical audience.

For other kinds of analysis, what you give is highly dependent on the type of analysis. But in general, talk about assumptions, if they are appropriate, how they might not be appropriate, and why you chose this type of analysis. 

## Visualization and interpretation of the results
Create visualizations of the results when appropriate, focusing on visualizations that 

- help describe aspects of the results that have real-world interpretation 
- help the reader understand how the model addresses the problem you are studying. 

**Visualizations are one of the most powerful ways to communicate information to the reader, so it is important to spend time producing clear, descriptive, eye-catching visualizations.**

Discuss the results of the model or models you chose, and describe how they are related to the problem statement or question that you were trying to answer in the project.  

If you have built multiple models or types of analysis, compare the measures of performance and the ease of interpretability across models or types of analysis, stating which model or models performed best, and which model or models were most interpretable.  Finally, decide which model or type of analysis is best for your particular problem based on some combination of performance and interpretability.

## Conclusions and Future Work
One or two paragraphs stating conclusions, recommendations, and ideas for future work and improvements.

 
